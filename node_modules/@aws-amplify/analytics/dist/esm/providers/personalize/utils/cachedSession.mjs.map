{"version":3,"file":"cachedSession.mjs","sources":["../../../../../src/providers/personalize/utils/cachedSession.ts"],"sourcesContent":["// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nimport { Cache } from '@aws-amplify/core';\nimport { amplifyUuid, isBrowser } from '@aws-amplify/core/internals/utils';\nconst PERSONALIZE_CACHE_USERID = '_awsct_uid';\nconst PERSONALIZE_CACHE_SESSIONID = '_awsct_sid';\nconst DEFAULT_CACHE_PREFIX = 'personalize';\nconst DELIMITER = '.';\nconst CACHE_EXPIRY_IN_DAYS = 7;\nconst normalize = (key) => [key, isBrowser() ? window.location.host : DEFAULT_CACHE_PREFIX].join(DELIMITER);\nconst getCache = (key) => Cache.getItem(normalize(key));\nconst setCache = (key, value) => {\n    const expiredAt = new Date(Date.now() + 3600000 * 24 * CACHE_EXPIRY_IN_DAYS);\n    Cache.setItem(normalize(key), value, {\n        expires: expiredAt.getTime(),\n    });\n};\nexport const resolveCachedSession = async () => {\n    let sessionId = await getCache(PERSONALIZE_CACHE_SESSIONID);\n    if (!sessionId) {\n        sessionId = amplifyUuid();\n        setCache(PERSONALIZE_CACHE_SESSIONID, sessionId);\n    }\n    const userId = await getCache(PERSONALIZE_CACHE_USERID);\n    return {\n        sessionId,\n        userId,\n    };\n};\nexport const updateCachedSession = (newUserId, currentSessionId, currentUserId) => {\n    const isNoCachedSession = !currentSessionId;\n    const isSignOutCase = !newUserId && !currentUserId;\n    const isSwitchUserCase = !!newUserId && !!currentUserId && newUserId !== currentUserId;\n    const isRequireNewSession = isNoCachedSession || isSignOutCase || isSwitchUserCase;\n    const isRequireUpdateSession = !!currentSessionId && !currentUserId && !!newUserId;\n    if (isRequireNewSession) {\n        const newSessionId = amplifyUuid();\n        setCache(PERSONALIZE_CACHE_SESSIONID, newSessionId);\n        setCache(PERSONALIZE_CACHE_USERID, newUserId);\n    }\n    else if (isRequireUpdateSession) {\n        setCache(PERSONALIZE_CACHE_USERID, newUserId);\n    }\n};\n"],"names":[],"mappings":";;;AAAA;AACA;AAGA,MAAM,wBAAwB,GAAG,YAAY,CAAC;AAC9C,MAAM,2BAA2B,GAAG,YAAY,CAAC;AACjD,MAAM,oBAAoB,GAAG,aAAa,CAAC;AAC3C,MAAM,SAAS,GAAG,GAAG,CAAC;AACtB,MAAM,oBAAoB,GAAG,CAAC,CAAC;AAC/B,MAAM,SAAS,GAAG,CAAC,GAAG,KAAK,CAAC,GAAG,EAAE,SAAS,EAAE,GAAG,MAAM,CAAC,QAAQ,CAAC,IAAI,GAAG,oBAAoB,CAAC,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;AAC5G,MAAM,QAAQ,GAAG,CAAC,GAAG,KAAK,KAAK,CAAC,OAAO,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC,CAAC;AACxD,MAAM,QAAQ,GAAG,CAAC,GAAG,EAAE,KAAK,KAAK;AACjC,IAAI,MAAM,SAAS,GAAG,IAAI,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,OAAO,GAAG,EAAE,GAAG,oBAAoB,CAAC,CAAC;AACjF,IAAI,KAAK,CAAC,OAAO,CAAC,SAAS,CAAC,GAAG,CAAC,EAAE,KAAK,EAAE;AACzC,QAAQ,OAAO,EAAE,SAAS,CAAC,OAAO,EAAE;AACpC,KAAK,CAAC,CAAC;AACP,CAAC,CAAC;AACU,MAAC,oBAAoB,GAAG,YAAY;AAChD,IAAI,IAAI,SAAS,GAAG,MAAM,QAAQ,CAAC,2BAA2B,CAAC,CAAC;AAChE,IAAI,IAAI,CAAC,SAAS,EAAE;AACpB,QAAQ,SAAS,GAAG,WAAW,EAAE,CAAC;AAClC,QAAQ,QAAQ,CAAC,2BAA2B,EAAE,SAAS,CAAC,CAAC;AACzD,KAAK;AACL,IAAI,MAAM,MAAM,GAAG,MAAM,QAAQ,CAAC,wBAAwB,CAAC,CAAC;AAC5D,IAAI,OAAO;AACX,QAAQ,SAAS;AACjB,QAAQ,MAAM;AACd,KAAK,CAAC;AACN,EAAE;AACU,MAAC,mBAAmB,GAAG,CAAC,SAAS,EAAE,gBAAgB,EAAE,aAAa,KAAK;AACnF,IAAI,MAAM,iBAAiB,GAAG,CAAC,gBAAgB,CAAC;AAChD,IAAI,MAAM,aAAa,GAAG,CAAC,SAAS,IAAI,CAAC,aAAa,CAAC;AACvD,IAAI,MAAM,gBAAgB,GAAG,CAAC,CAAC,SAAS,IAAI,CAAC,CAAC,aAAa,IAAI,SAAS,KAAK,aAAa,CAAC;AAC3F,IAAI,MAAM,mBAAmB,GAAG,iBAAiB,IAAI,aAAa,IAAI,gBAAgB,CAAC;AACvF,IAAI,MAAM,sBAAsB,GAAG,CAAC,CAAC,gBAAgB,IAAI,CAAC,aAAa,IAAI,CAAC,CAAC,SAAS,CAAC;AACvF,IAAI,IAAI,mBAAmB,EAAE;AAC7B,QAAQ,MAAM,YAAY,GAAG,WAAW,EAAE,CAAC;AAC3C,QAAQ,QAAQ,CAAC,2BAA2B,EAAE,YAAY,CAAC,CAAC;AAC5D,QAAQ,QAAQ,CAAC,wBAAwB,EAAE,SAAS,CAAC,CAAC;AACtD,KAAK;AACL,SAAS,IAAI,sBAAsB,EAAE;AACrC,QAAQ,QAAQ,CAAC,wBAAwB,EAAE,SAAS,CAAC,CAAC;AACtD,KAAK;AACL;;;;"}