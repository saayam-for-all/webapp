{"version":3,"file":"signInWithUserAuth.js","sources":["../../../../../src/providers/cognito/apis/signInWithUserAuth.ts"],"sourcesContent":["\"use strict\";\n// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.signInWithUserAuth = void 0;\nconst core_1 = require(\"@aws-amplify/core\");\nconst utils_1 = require(\"@aws-amplify/core/internals/utils\");\nconst validation_1 = require(\"../../../errors/types/validation\");\nconst assertValidationError_1 = require(\"../../../errors/utils/assertValidationError\");\nconst assertServiceError_1 = require(\"../../../errors/utils/assertServiceError\");\nconst signInHelpers_1 = require(\"../utils/signInHelpers\");\nconst store_1 = require(\"../../../client/utils/store\");\nconst signInStore_1 = require(\"../../../client/utils/store/signInStore\");\nconst cacheTokens_1 = require(\"../tokenProvider/cacheTokens\");\nconst dispatchSignedInHubEvent_1 = require(\"../utils/dispatchSignedInHubEvent\");\nconst tokenProvider_1 = require(\"../tokenProvider\");\nconst handleUserAuthFlow_1 = require(\"../../../client/flows/userAuth/handleUserAuthFlow\");\nconst getNewDeviceMetadata_1 = require(\"../utils/getNewDeviceMetadata\");\nconst autoSignIn_1 = require(\"./autoSignIn\");\n/**\n * Signs a user in through a registered email or phone number without a password by by receiving and entering an OTP.\n *\n * @param input - The SignInWithUserAuthInput object\n * @returns SignInWithUserAuthOutput\n * @throws service: {@link InitiateAuthException }, {@link RespondToAuthChallengeException } - Cognito service errors\n * thrown during the sign-in process.\n * @throws validation: {@link AuthValidationErrorCode  } - Validation errors thrown when either username or password -- needs to change\n *  are not defined.\n * @throws AuthTokenConfigException - Thrown when the token provider config is invalid.\n */\nasync function signInWithUserAuth(input) {\n    const { username, password, options } = input;\n    const authConfig = core_1.Amplify.getConfig().Auth?.Cognito;\n    const signInDetails = {\n        loginId: username,\n        authFlowType: 'USER_AUTH',\n    };\n    (0, utils_1.assertTokenProviderConfig)(authConfig);\n    const clientMetaData = options?.clientMetadata;\n    const preferredChallenge = options?.preferredChallenge;\n    (0, assertValidationError_1.assertValidationError)(!!username, validation_1.AuthValidationErrorCode.EmptySignInUsername);\n    try {\n        const handleUserAuthFlowInput = {\n            username,\n            config: authConfig,\n            tokenOrchestrator: tokenProvider_1.tokenOrchestrator,\n            clientMetadata: clientMetaData,\n            preferredChallenge,\n            password,\n        };\n        const autoSignInStoreState = store_1.autoSignInStore.getState();\n        if (autoSignInStoreState.active &&\n            autoSignInStoreState.username === username) {\n            handleUserAuthFlowInput.session = autoSignInStoreState.session;\n        }\n        const response = await (0, handleUserAuthFlow_1.handleUserAuthFlow)(handleUserAuthFlowInput);\n        const activeUsername = (0, signInHelpers_1.getActiveSignInUsername)(username);\n        (0, signInStore_1.setActiveSignInState)({\n            signInSession: response.Session,\n            username: activeUsername,\n            challengeName: response.ChallengeName,\n            signInDetails,\n        });\n        if (response.AuthenticationResult) {\n            await (0, cacheTokens_1.cacheCognitoTokens)({\n                username: activeUsername,\n                ...response.AuthenticationResult,\n                NewDeviceMetadata: await (0, getNewDeviceMetadata_1.getNewDeviceMetadata)({\n                    userPoolId: authConfig.userPoolId,\n                    userPoolEndpoint: authConfig.userPoolEndpoint,\n                    newDeviceMetadata: response.AuthenticationResult.NewDeviceMetadata,\n                    accessToken: response.AuthenticationResult.AccessToken,\n                }),\n                signInDetails,\n            });\n            (0, signInStore_1.resetActiveSignInState)();\n            await (0, dispatchSignedInHubEvent_1.dispatchSignedInHubEvent)();\n            (0, autoSignIn_1.resetAutoSignIn)();\n            return {\n                isSignedIn: true,\n                nextStep: { signInStep: 'DONE' },\n            };\n        }\n        return (0, signInHelpers_1.getSignInResult)({\n            challengeName: response.ChallengeName,\n            challengeParameters: response.ChallengeParameters,\n            availableChallenges: 'AvailableChallenges' in response\n                ? response.AvailableChallenges\n                : undefined,\n        });\n    }\n    catch (error) {\n        (0, signInStore_1.resetActiveSignInState)();\n        (0, autoSignIn_1.resetAutoSignIn)();\n        (0, assertServiceError_1.assertServiceError)(error);\n        const result = (0, signInHelpers_1.getSignInResultFromError)(error.name);\n        if (result)\n            return result;\n        throw error;\n    }\n}\nexports.signInWithUserAuth = signInWithUserAuth;\n"],"names":[],"mappings":"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"}