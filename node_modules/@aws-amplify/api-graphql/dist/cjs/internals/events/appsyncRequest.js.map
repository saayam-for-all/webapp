{"version":3,"file":"appsyncRequest.js","sources":["../../../../src/internals/events/appsyncRequest.ts"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.appsyncRequest = void 0;\nconst utils_1 = require(\"@aws-amplify/core/internals/utils\");\nconst internals_1 = require(\"@aws-amplify/api-rest/internals\");\nconst utils_2 = require(\"../../utils\");\nconst repackageAuthError_1 = require(\"../../utils/errors/repackageAuthError\");\nconst graphqlAuth_1 = require(\"../graphqlAuth\");\nconst isGraphQLResponseWithErrors_1 = require(\"../utils/runtimeTypeGuards/isGraphQLResponseWithErrors\");\nconst USER_AGENT_HEADER = 'x-amz-user-agent';\n// This is effectively a copy of InternalGraphQLAPI.ts._graphql(...)\n// Our existing unit tests are tightly coupled to the implementation, so i was unable to refactor\n// and extend _graphql() without having to change a bunch of tests as well... which in turn reduces confidence\n// that this feature will _not affect_ GQL behavior.\nasync function appsyncRequest(amplify, options, additionalHeaders = {}, abortController, customUserAgentDetails) {\n    const { region, appSyncGraphqlEndpoint: endpoint, authenticationType: authMode, query, variables, } = options;\n    if (!endpoint) {\n        throw new Error('No endpoint');\n    }\n    const { withCredentials } = (0, utils_2.resolveLibraryOptions)(amplify);\n    const headers = await requestHeaders(amplify, options, additionalHeaders, customUserAgentDetails);\n    const body = {\n        channel: query,\n        events: variables,\n    };\n    const signingServiceInfo = ['apiKey', 'none'].includes(authMode)\n        ? undefined\n        : {\n            service: 'appsync',\n            region,\n        };\n    const { body: responseBody } = await (0, internals_1.post)(amplify, {\n        url: new utils_1.AmplifyUrl(endpoint),\n        options: {\n            headers,\n            body,\n            signingServiceInfo,\n            withCredentials,\n        },\n        abortController,\n    });\n    const response = await responseBody.json();\n    if ((0, isGraphQLResponseWithErrors_1.isGraphQLResponseWithErrors)(response)) {\n        throw (0, repackageAuthError_1.repackageUnauthorizedError)(response);\n    }\n    return response;\n}\nexports.appsyncRequest = appsyncRequest;\n/**\n * Computes all the necessary HTTP headers for the request based on:\n * 1. Operation-level header options\n * 2. Amplify.configure custom headers\n * 3. AuthZ headers for explicit auth mode specified for operation ?? default auth mode in config\n *\n * @returns HTTP request headers key/value\n */\nasync function requestHeaders(amplify, options, additionalHeaders, customUserAgentDetails) {\n    const { apiKey, appSyncGraphqlEndpoint: endpoint, authenticationType: authMode, query, variables, authToken, } = options;\n    const { headers: customHeadersFn } = (0, utils_2.resolveLibraryOptions)(amplify);\n    let additionalCustomHeaders;\n    if (typeof additionalHeaders === 'function') {\n        const requestOptions = {\n            method: 'POST',\n            url: new utils_1.AmplifyUrl(endpoint).toString(),\n            queryString: query,\n        };\n        additionalCustomHeaders = await additionalHeaders(requestOptions);\n    }\n    else {\n        additionalCustomHeaders = additionalHeaders;\n    }\n    // if an authorization header is set, have the operation-level authToken take precedence\n    if (authToken) {\n        additionalCustomHeaders = {\n            ...additionalCustomHeaders,\n            Authorization: authToken,\n        };\n    }\n    const authHeaders = await (0, graphqlAuth_1.headerBasedAuth)(amplify, authMode, apiKey, additionalCustomHeaders);\n    const customHeaders = customHeadersFn &&\n        (await customHeadersFn({\n            query,\n            variables: variables,\n        }));\n    const headers = {\n        ...authHeaders,\n        // Custom headers included in Amplify configuration options:\n        ...customHeaders,\n        // Custom headers from individual requests or API client configuration:\n        ...additionalCustomHeaders,\n        // User agent headers:\n        [USER_AGENT_HEADER]: (0, utils_1.getAmplifyUserAgent)(customUserAgentDetails),\n    };\n    return headers;\n}\n"],"names":[],"mappings":"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"}